<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPS Route Processor</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
      background: #1a1a1a;
      color: #0f0;
    }
    
    h1 {
      color: #0ff;
    }
    
    .section {
      background: #000;
      border: 1px solid #0f0;
      padding: 1.5rem;
      margin: 1rem 0;
      border-radius: 4px;
    }
    
    button {
      background: #0f0;
      color: #000;
      border: none;
      padding: 0.75rem 1.5rem;
      font-family: 'Courier New', monospace;
      font-size: 1rem;
      cursor: pointer;
      margin: 0.5rem 0.5rem 0.5rem 0;
      border-radius: 4px;
    }
    
    button:hover {
      background: #0ff;
    }
    
    input[type="file"] {
      margin: 1rem 0;
    }
    
    textarea {
      width: 100%;
      min-height: 200px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      background: #000;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 1rem;
      border-radius: 4px;
    }
    
    .output {
      background: #000;
      color: #ff0;
      padding: 1rem;
      border: 1px solid #ff0;
      border-radius: 4px;
      margin: 1rem 0;
      white-space: pre-wrap;
      font-size: 0.85rem;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .waypoint-input {
      display: grid;
      grid-template-columns: 1fr 1fr 2fr;
      gap: 0.5rem;
      margin: 0.5rem 0;
    }
    
    input[type="number"], input[type="text"] {
      background: #000;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 0.5rem;
      font-family: 'Courier New', monospace;
    }
    
    .log {
      color: #888;
      font-size: 0.85rem;
      margin: 0.25rem 0;
    }
  </style>
</head>
<body>
  <h1>GPS Route Processor</h1>
  <p>Upload your GPS track file and process it for the Iceland Radio Installation</p>
  
  <!-- Step 1: Upload GPS File -->
  <div class="section">
    <h2>Step 1: Upload GPS Track</h2>
    <p>Supported formats: GPX, KML, GeoJSON</p>
    <input type="file" id="gps-file" accept=".gpx,.kml,.geojson,.json">
    <button onclick="processGPSFile()">Process File</button>
    <div id="gps-log" class="output" style="display:none;"></div>
  </div>
  
  <!-- Step 2: Define Section Boundaries -->
  <div class="section">
    <h2>Step 2: Define Section Boundaries</h2>
    <p>Enter 5 waypoints: start, 3 section boundaries, and end</p>
    
    <div id="waypoints-container">
      <div class="waypoint-input">
        <input type="number" step="0.0001" placeholder="Latitude" data-waypoint="0" data-field="lat" value="64.1466">
        <input type="number" step="0.0001" placeholder="Longitude" data-waypoint="0" data-field="lng" value="-21.9426">
        <input type="text" placeholder="Name (e.g., Reykjavik)" data-waypoint="0" data-field="name" value="Reykjavik (start)">
      </div>
      <div class="waypoint-input">
        <input type="number" step="0.0001" placeholder="Latitude" data-waypoint="1" data-field="lat" value="63.9333">
        <input type="number" step="0.0001" placeholder="Longitude" data-waypoint="1" data-field="lng" value="-20.9833">
        <input type="text" placeholder="Name" data-waypoint="1" data-field="name" value="Selfoss">
      </div>
      <div class="waypoint-input">
        <input type="number" step="0.0001" placeholder="Latitude" data-waypoint="2" data-field="lat" value="63.4186">
        <input type="number" step="0.0001" placeholder="Longitude" data-waypoint="2" data-field="lng" value="-19.0059">
        <input type="text" placeholder="Name" data-waypoint="2" data-field="name" value="Vik">
      </div>
      <div class="waypoint-input">
        <input type="number" step="0.0001" placeholder="Latitude" data-waypoint="3" data-field="lat" value="64.2539">
        <input type="number" step="0.0001" placeholder="Longitude" data-waypoint="3" data-field="lng" value="-15.2082">
        <input type="text" placeholder="Name" data-waypoint="3" data-field="name" value="Hofn">
      </div>
      <div class="waypoint-input">
        <input type="number" step="0.0001" placeholder="Latitude" data-waypoint="4" data-field="lat" value="64.1466">
        <input type="number" step="0.0001" placeholder="Longitude" data-waypoint="4" data-field="lng" value="-21.9426">
        <input type="text" placeholder="Name" data-waypoint="4" data-field="name" value="Reykjavik (end)">
      </div>
    </div>
    
    <button onclick="splitIntoSections()">Split Into Sections</button>
    <div id="split-log" class="output" style="display:none;"></div>
  </div>
  
  <!-- Step 3: Generate Configuration -->
  <div class="section">
    <h2>Step 3: Generate Configuration</h2>
    <button onclick="generateConfig()">Generate route-config.js</button>
    <div id="config-output" class="output" style="display:none;"></div>
    <button onclick="copyToClipboard()" style="display:none;" id="copy-btn">Copy to Clipboard</button>
  </div>
  
  <script type="module">
    import * as ConfigHelper from './src/utils/config-helper.js';
    
    // Make available globally for onclick handlers
    window.ConfigHelper = ConfigHelper;
    window.gpsData = {
      rawCoordinates: null,
      simplifiedCoordinates: null,
      sections: null,
      waypoints: null
    };
    
    window.processGPSFile = async function() {
      const fileInput = document.getElementById('gps-file');
      const log = document.getElementById('gps-log');
      
      if (!fileInput.files[0]) {
        alert('Please select a file first');
        return;
      }
      
      const file = fileInput.files[0];
      const content = await file.text();
      const extension = file.name.split('.').pop().toLowerCase();
      
      log.style.display = 'block';
      log.textContent = 'Processing...\n';
      
      try {
        let coordinates;
        
        if (extension === 'gpx') {
          coordinates = ConfigHelper.parseGPX(content);
          log.textContent += 'Parsed GPX file\n';
        } else if (extension === 'kml') {
          coordinates = ConfigHelper.parseKML(content);
          log.textContent += 'Parsed KML file\n';
        } else if (extension === 'geojson' || extension === 'json') {
          coordinates = ConfigHelper.parseGeoJSON(content);
          log.textContent += 'Parsed GeoJSON file\n';
        } else {
          throw new Error('Unsupported file format');
        }
        
        log.textContent += `Extracted ${coordinates.length} coordinates\n`;
        
        // Simplify
        const simplified = ConfigHelper.simplifyPath(coordinates, 0.001);
        log.textContent += `Simplified to ${simplified.length} coordinates\n`;
        
        window.gpsData.rawCoordinates = coordinates;
        window.gpsData.simplifiedCoordinates = simplified;
        
        log.textContent += '\n✓ Ready to split into sections';
        
      } catch (error) {
        log.textContent += `\n✗ Error: ${error.message}`;
      }
    };
    
    window.splitIntoSections = function() {
      const log = document.getElementById('split-log');
      
      if (!window.gpsData.simplifiedCoordinates) {
        alert('Please process a GPS file first');
        return;
      }
      
      log.style.display = 'block';
      log.textContent = 'Splitting into sections...\n';
      
      try {
        // Get waypoints from inputs
        const waypoints = [];
        const names = [];
        
        for (let i = 0; i < 5; i++) {
          const lat = parseFloat(document.querySelector(`input[data-waypoint="${i}"][data-field="lat"]`).value);
          const lng = parseFloat(document.querySelector(`input[data-waypoint="${i}"][data-field="lng"]`).value);
          const name = document.querySelector(`input[data-waypoint="${i}"][data-field="name"]`).value;
          
          waypoints.push([lat, lng]);
          if (i < 4) names.push(name); // Section names (exclude last waypoint)
        }
        
        // Split
        const sections = ConfigHelper.splitPathBySections(
          window.gpsData.simplifiedCoordinates,
          waypoints
        );
        
        window.gpsData.sections = sections;
        window.gpsData.sectionNames = names;
        
        log.textContent += `\n✓ Split into ${sections.length} sections:\n`;
        sections.forEach((section, i) => {
          log.textContent += `  Section ${i + 1} (${names[i]}): ${section.length} points\n`;
        });
        
        log.textContent += '\n✓ Ready to generate configuration';
        
      } catch (error) {
        log.textContent += `\n✗ Error: ${error.message}`;
      }
    };
    
    window.generateConfig = function() {
      const output = document.getElementById('config-output');
      const copyBtn = document.getElementById('copy-btn');
      
      if (!window.gpsData.sections) {
        alert('Please split into sections first');
        return;
      }
      
      output.style.display = 'block';
      copyBtn.style.display = 'inline-block';
      
      const config = ConfigHelper.generateConfigTemplate(
        window.gpsData.sections,
        window.gpsData.sectionNames
      );
      
      output.textContent = config;
      window.generatedConfig = config;
    };
    
    window.copyToClipboard = function() {
      navigator.clipboard.writeText(window.generatedConfig).then(() => {
        alert('Copied to clipboard! Paste into src/data/route-config.js');
      });
    };
  </script>
</body>
</html>
